name: Create Free Branch

on:
  push:
    branches:
      - master

jobs:
  create-free-branch:
    if: contains(github.event.head_commit.message, 'free')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Free用に不要ファイルを削除
        run: |
          rm -rf assets
          rm -rf blocks
          rm -rf css/webfonts
          rm -rf css/*.js
          rm -rf css/*.json
          rm -rf css/css
          rm -rf css/src/awesome-all.css
          rm -rf css/src/module.css
          rm -rf css/build/awesome-all.css
          rm -rf css/build/module.css
          rm -rf inc/aurora-design-blocks-auroraDesignBlocks-pro.php
          rm -rf inc/aurora-design-blocks-awesome.php
          rm -rf inc/aurora-design-blocks-forBlocks.php
          rm -rf inc/aurora-design-blocks-pattern.php
          rm -rf inc/aurora-design-blocks-popularPosts.php
          rm -rf languages/*.json
          rm -rf patterns
          rm -rf plugin-update-checker
          rm -rf tmp
          rm -f aurora-design-blocks-pro.php
          rm -f *.json
          rm -f *.lock
          rm -f *phpcs.xml*
          rm -f *phpunit*
          rm -f .phpcs.xml.dist
          rm -f .phpunit.result.cache

      - name: Free用にバージョンを1つ下げる
        run: |
          ver=$(grep -i "^[[:space:]]*\*[[:space:]]*Version:" aurora-design-blocks.php \
                | sed -E 's/.*Version:[[:space:]]*([0-9.]+).*/\1/')
          major=$(echo "$ver" | cut -d. -f1)
          rest=$(echo "$ver" | cut -d. -f2-)
          major_minus1=$((major - 1))
          ver_minus1="${major_minus1}.${rest}"
          # -------------------------------
          # 3) Version: を更新（PHPヘッダ）
          # -------------------------------
          sed -i "s/^\([[:space:]]*\*[[:space:]]*Version:\)[[:space:]]*[0-9.]\+/\1 $ver_minus1/" aurora-design-blocks.php
          # -------------------------------
          # 4) define('AURORA_DESIGN_BLOCKS_VERSION', 'x.y.z');
          # -------------------------------
          sed -i "s/define('AURORA_DESIGN_BLOCKS_VERSION', '[0-9.]*');/define('AURORA_DESIGN_BLOCKS_VERSION', '$ver_minus1');/" aurora-design-blocks.php
          # -------------------------------
          # 5) readme.txt の Stable tag:
          # -------------------------------
          sed -i "s/^Stable tag: [0-9.]*/Stable tag: $ver_minus1/" readme.txt

      - name: Freeブランチを作成・更新
        run: |
          git config user.name github-actions
          git config user.email actions@github.com

          git checkout -B free
          git add -A
          git commit -m "Auto-generate free branch from master" || echo "No changes to commit"
          git push origin free --force
