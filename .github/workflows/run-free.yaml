name: Release

on:
  push:
    branches: [free]

jobs:
  upload-release-asset:
    if: |
      contains(github.event.head_commit.message, 'fdouki') &&
      !contains(github.event.head_commit.message, 'build: add vendor')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # =======================================================
      # 1. 依存ライブラリのインストール (新規追加)
      # =======================================================
      - name: Install PHP Dependencies (Production)
        uses: ramsey/composer-install@v3 # Composerインストールを効率的に行うAction
        with:
          # --no-dev: 開発環境専用の依存関係 (require-dev) はインストールしない
          # --optimize-autoloader: オートローダーを最適化 (本番環境向け)
          # --no-interaction: 対話モードを無効化
          no-dev: true
          optimize-autoloader: true
          no-interaction: true

      - name: build
        # ホワイトリスト方式：リリースに必要なファイルとディレクトリのみを指定してzip化します。
        run: |
          zip -r aurora-design-blocks.zip \
            "blocks/" \
            "css/" \
            "patterns/" \
            "assets/" \
            "inc/" \
            "languages/" \
            "plugin-update-checker/" \
            "webfonts/" \
            "aurora-design-blocks.php" \
            "aurora-design-blocks-pro.php" \
            "readme.txt" \
            "vendor/" \
            -x "inc/aurora-design-blocks-textDomain.php"

      - name: リリースを作成する
        uses: actions/create-release@v1
        id: create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: tag_free_${{ github.ref }}_${{github.sha}}
          release_name: Release ${{ github.ref }}
          body: release body

      - name: リリースアセットをアップロードする
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_name: aurora-design-blocks.zip
          asset_path: ./aurora-design-blocks.zip
          asset_content_type: application/zip

      - name: Commit vendor
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -f vendor
          git commit -m "build: add vendor for free release"
          git push origin free
